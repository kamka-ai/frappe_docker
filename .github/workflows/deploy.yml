name: Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd ~/frappe_docker || { echo "Directory not found"; exit 1; }
            # Update remote to include token for authentication
            git remote set-url origin https://${{ secrets.GHCR_PAT }}@github.com/kamka-ai/frappe_docker.git
            git pull origin main
            export SITES="erp.kamka.cloud"
            export LETSENCRYPT_EMAIL="contact@kamka.cloud" # Update this if needed or use secret
            
            # Pull latest images if needed (optional, depends on if you use :latest or specific tags)
            # docker compose pull
            
            # Start/Restart services with Traefik SSL and DB/Redis overrides
            sudo docker compose \
              -f compose.yaml \
              -f overrides/compose.https.yaml \
              -f overrides/compose.mariadb.yaml \
              -f overrides/compose.redis.yaml \
              up -d --remove-orphans
